name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Target Version (e.g. v0.1.2)'
        required: true
        type: string

jobs:
  bump-and-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Bump Version
        run: |
          CLEAN_VERSION=$(echo "${{ inputs.version }}" | sed 's/^v//')
          cargo set-version "$CLEAN_VERSION"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Cargo.toml Cargo.lock
          git commit -m "chore: release v$CLEAN_VERSION [no ci]"
          
          git tag "v$CLEAN_VERSION"
          
          git push
          git push origin "v$CLEAN_VERSION"

  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh release create ${{ github.ref_name }} \
            --draft=false \
            --prerelease=false \
            --generate-notes

